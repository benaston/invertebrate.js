<!DOCTYPE html>

<html>
<head>
  <title>Router.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="App.html">
                App.js
              </a>
            
              
              <a class="source" href="Config.html">
                Config.js
              </a>
            
              
              <a class="source" href="Logger.html">
                Logger.js
              </a>
            
              
              <a class="source" href="Model.html">
                Model.js
              </a>
            
              
              <a class="source" href="Router.html">
                Router.js
              </a>
            
              
              <a class="source" href="SyncSvc.html">
                SyncSvc.js
              </a>
            
              
              <a class="source" href="TemplateUriHelper.html">
                TemplateUriHelper.js
              </a>
            
              
              <a class="source" href="View.html">
                View.js
              </a>
            
              
              <a class="source" href="env.html">
                env.js
              </a>
            
              
              <a class="source" href="invertebrate.html">
                invertebrate.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Router.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="function"><span class="keyword">function</span> <span class="params">(invertebrate)</span> {</span>
    <span class="string">"use strict"</span>;

    <span class="function"><span class="keyword">function</span> <span class="title">Router</span><span class="params">(defaultPageTitle)</span> {</span>

        <span class="keyword">var</span> that = <span class="keyword">this</span>,
            _defaultPageTitle = <span class="literal">null</span>;

        <span class="keyword">this</span>.routes = {};

        <span class="keyword">this</span>.registerRoute = <span class="function"><span class="keyword">function</span> <span class="params">(uri, action, options)</span> {</span>
            <span class="keyword">var</span> defaults = { silent: <span class="literal">false</span>, title: _defaultPageTitle };
            options = _.extend({}, defaults, options);

            that.routes[uri] = { action: action, options: options };
        };

        <span class="keyword">this</span>.redirect = <span class="function"><span class="keyword">function</span> <span class="params">(uri)</span> {</span>
            history.pushState(<span class="literal">null</span>, <span class="literal">null</span>, uri);
        };

        <span class="keyword">this</span>.route = <span class="function"><span class="keyword">function</span> <span class="params">(uri, dto, options)</span> {</span>
            options  = options || { silent: <span class="literal">false</span> };

            <span class="keyword">var</span> splitUri = uri.split(<span class="string">'?'</span>);
            <span class="keyword">var</span> uriWithoutQueryString = splitUri[<span class="number">0</span>];
            <span class="keyword">var</span> queryString = splitUri[<span class="number">1</span>];

            <span class="keyword">var</span> escapedRoute = uriWithoutQueryString.replace(<span class="regexp">/\//g</span>, <span class="string">'\\/'</span>);
            <span class="keyword">var</span> pattern = <span class="keyword">new</span> RegExp(<span class="string">'^'</span> + escapedRoute, <span class="string">'g'</span>);

            <span class="keyword">var</span> firstMatchingRouteUri = _.filter(Object.keys(that.routes), <span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
                <span class="keyword">return</span> pattern.exec(key);
            })[<span class="number">0</span>];

            <span class="keyword">if</span> (!firstMatchingRouteUri) {
                <span class="keyword">throw</span> <span class="string">"no matching route "</span> + uriWithoutQueryString;
            }

            <span class="keyword">var</span> route = that.routes[firstMatchingRouteUri];

            <span class="keyword">if</span> (!route.options.silent &amp;&amp; !options.silent) {
                document.title = route.options.title;
                history.pushState(<span class="literal">null</span>, <span class="literal">null</span>, uri);
            }

            <span class="keyword">if</span> (!queryString || dto) {
                route.action(dto);

                <span class="keyword">return</span>;
            }

            <span class="keyword">var</span> queryStringArguments = queryString.split(<span class="string">'&amp;'</span>);
            route.action(extractQueryString(queryStringArguments));
        };

        <span class="function"><span class="keyword">function</span> <span class="title">routeHyperlink</span><span class="params">(evt)</span> {</span>
            <span class="keyword">var</span> href = $(<span class="keyword">this</span>).attr(<span class="string">'href'</span>);
            <span class="keyword">var</span> protocol = <span class="string">'http//'</span>;

            <span class="keyword">if</span> (href.slice(protocol.length) !== protocol) {
                evt.preventDefault();
                that.route(href);
            }
        }

        <span class="function"><span class="keyword">function</span> <span class="title">routeFormSubmission</span><span class="params">(evt)</span> {</span>
            <span class="keyword">var</span> action = $(<span class="keyword">this</span>).attr(<span class="string">'action'</span>);
            <span class="keyword">var</span> protocol = <span class="string">'http//'</span>;

            <span class="keyword">if</span> (action.slice(protocol.length) !== protocol) {
                evt.preventDefault();

                that.route(action, createDtoFromForm($(<span class="keyword">this</span>)));
            }
        }

        <span class="function"><span class="keyword">function</span> <span class="title">createDtoFromForm</span><span class="params">($form)</span> {</span>
            <span class="keyword">var</span> dto = {};
            <span class="keyword">var</span> $textfields = $form.find(<span class="string">'input[type=text],input[type=password]'</span>);
            _.each($textfields, <span class="function"><span class="keyword">function</span><span class="params">($t)</span> {</span> dto[$t.name] = $t.value; })

            <span class="keyword">var</span> $selections = $form.find(<span class="string">'input[type=radio]:checked,input[type=checkbox]:checked'</span>);
            _.each($selections, <span class="function"><span class="keyword">function</span><span class="params">($r)</span> {</span> dto[$r.name] = $r.value; })

            <span class="keyword">return</span> dto;
        }

        <span class="function"><span class="keyword">function</span> <span class="title">extractQueryString</span><span class="params">(queryString)</span> {</span>
            <span class="keyword">if</span> (queryString == <span class="string">""</span>) <span class="keyword">return</span> {};
            <span class="keyword">var</span> b = {};
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; queryString.length; ++i) {
                <span class="keyword">var</span> p = queryString[i].split(<span class="string">'='</span>);
                <span class="keyword">if</span> (p.length != <span class="number">2</span>) <span class="keyword">continue</span>;
                b[p[<span class="number">0</span>]] = decodeURIComponent(p[<span class="number">1</span>].replace(<span class="regexp">/\+/g</span>, <span class="string">" "</span>));
            }
            <span class="keyword">return</span> b;
        }

        <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> {</span>
            <span class="keyword">if</span>(!defaultPageTitle) {
                <span class="keyword">throw</span> <span class="string">'defaultPageTitle not supplied.'</span>;
            }

            _defaultPageTitle = defaultPageTitle;

            window.addEventListener(<span class="string">"popstate"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> {</span>
                that.route(location.pathname + location.search, <span class="literal">null</span>, {silent:<span class="literal">true</span>});
            });

            $(document).on(<span class="string">'click'</span>, <span class="string">'a:not([data-bypass-router])'</span>, routeHyperlink);
            $(document).on(<span class="string">'submit'</span>, <span class="string">'form'</span>, routeFormSubmission);
        }

        init();
    }

    invertebrate.Router = Router;
}(invertebrate));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
